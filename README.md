# pythonä¸‹è½½å¤ç›®å‹äººå¸

   ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ä½¿ç”¨çˆ¬è™«æ›´å¤šçš„åº”è¯¥æ˜¯çˆ¬æ•°æ®æˆ–è€…å›¾ç‰‡å§,ä»Šå¤©åœ¨è¿™é‡Œå’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹å…³äºä½¿ç”¨çˆ¬è™«æŠ€æœ¯æ¥è¿›è¡Œè§†é¢‘ä¸‹è½½çš„æ–¹æ³•,ä¸ä»…å¯ä»¥æ–¹ä¾¿çš„ä¸‹è½½ä¸€äº›ä½“ç§¯å°çš„è§†é¢‘,é’ˆå¯¹å¤§å®¹é‡çš„è§†é¢‘ä¸‹è½½åŒæ ·è¯•ç”¨ã€‚
![](https://img2018.cnblogs.com/blog/736399/201902/736399-20190228212836700-1955556009.jpg)
### å…ˆä¸Šä¸ªğŸŒ°
#### requestsæ¨¡å—çš„iter_contentæ–¹æ³•
è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯pythonçš„requestsæ¨¡å—ä½œä¸ºä¾‹å­,éœ€è¦è·å–æ–‡æœ¬çš„æ—¶å€™æˆ‘ä»¬ä¼šä½¿ç”¨response.textè·å–æ–‡æœ¬ä¿¡æ¯,ä½¿ç”¨response.contentè·å–å­—èŠ‚æµ,æ¯”å¦‚ä¸‹è½½å›¾ç‰‡ä¿å­˜åˆ°ä¸€ä¸ªæ–‡ä»¶,è€Œå¯¹äºå¤§ä¸ªçš„æ–‡ä»¶æˆ‘ä»¬å°±è¦é‡‡å–åˆ†å—è¯»å–çš„æ–¹å¼äº†,
#### requests.getæ–¹æ³•çš„stream
ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®requests.getçš„streamå‚æ•°ä¸ºTrueã€‚
é»˜è®¤æƒ…å†µä¸‹æ˜¯streamçš„å€¼ä¸ºfalseï¼Œå®ƒä¼šç«‹å³å¼€å§‹ä¸‹è½½æ–‡ä»¶å¹¶å­˜æ”¾åˆ°å†…å­˜å½“ä¸­ï¼Œå€˜è‹¥æ–‡ä»¶è¿‡å¤§å°±ä¼šå¯¼è‡´å†…å­˜ä¸è¶³çš„æƒ…å†µï¼
å½“æŠŠgetå‡½æ•°çš„streamå‚æ•°è®¾ç½®æˆTrueæ—¶ï¼Œå®ƒä¸ä¼šç«‹å³å¼€å§‹ä¸‹è½½ï¼Œå½“ä½ ä½¿ç”¨iter_contentæˆ–iter_lineséå†å†…å®¹æˆ–è®¿é—®å†…å®¹å±æ€§æ—¶æ‰å¼€å§‹ä¸‹è½½ã€‚éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼šæ–‡ä»¶æ²¡æœ‰ä¸‹è½½ä¹‹å‰ï¼Œå®ƒä¹Ÿéœ€è¦ä¿æŒè¿æ¥ã€‚
```
iter_contentï¼šä¸€å—ä¸€å—çš„éå†è¦ä¸‹è½½çš„å†…å®¹
iter_linesï¼šä¸€è¡Œä¸€è¡Œçš„éå†è¦ä¸‹è½½çš„å†…å®¹
```
ä½¿ç”¨ä¸Šé¢ä¸¤ä¸ªå‡½æ•°ä¸‹è½½å¤§æ–‡ä»¶å¯ä»¥é˜²æ­¢å ç”¨è¿‡å¤šçš„å†…å­˜ï¼Œå› ä¸ºæ¯æ¬¡åªä¸‹è½½å°éƒ¨åˆ†æ•°æ®ã€‚
ç¤ºä¾‹ä»£ç :
```
r = requests.get(url_file, stream=True)
f = open("file_path", "wb")
for chunk in r.iter_content(chunk_size=512):
     if chunk:
        f.write(chunk)
```
ä¸Šé¢çš„ä»£ç è¡¨ç¤ºè¯·æ±‚äº†url_fileï¼Œè¿™ä¸ªurl_fileæ˜¯ä¸€ä¸ªå¤§æ–‡ä»¶,æ‰€ä»¥å¼€å¯äº†streamæ¨¡å¼ï¼Œç„¶åé€šè¿‡è¿­ä»£rå¯¹è±¡çš„iter_contentæ–¹æ³•ï¼ŒåŒæ—¶æŒ‡å®šchunk_size=512ï¼ˆå³æ¯æ¬¡è¯»å–512ä¸ªå­—èŠ‚ï¼‰æ¥è¿›è¡Œè¯»å–ã€‚ä½†æ˜¯å¦‚æœä»…ä»…æ˜¯è¿­ä»£æ˜¯ä¸è¡Œï¼Œå¦‚æœä¸‹è½½ä¸­é€”å‡ºç°é—®é¢˜æˆ‘ä»¬ä¹‹å‰çš„åŠªåŠ›å°±ç™½è´¹äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åšåˆ°ä¸€ä¸ªæ–­ç‚¹ç»­ä¼ çš„åŠŸèƒ½ã€‚
### æ–­ç‚¹ç»­ä¼ 
æ‰€è°“æ–­ç‚¹ç»­ä¼ ï¼Œä¹Ÿå°±æ˜¯è¦ä»æ–‡ä»¶å·²ç»ä¸‹è½½çš„åœ°æ–¹å¼€å§‹ç»§ç»­ä¸‹è½½ã€‚åœ¨ä»¥å‰ç‰ˆæœ¬çš„ HTTP åè®®æ˜¯ä¸æ”¯æŒæ–­ç‚¹çš„ï¼ŒHTTP/1.1 å¼€å§‹å°±æ”¯æŒäº†ã€‚ä¸€èˆ¬æ–­ç‚¹ä¸‹è½½æ—¶ä¼šç”¨åˆ° headerè¯·æ±‚å¤´çš„Rangeå­—æ®µï¼Œè¿™ä¹Ÿæ˜¯ç°åœ¨ä¼—å¤šå·ç§°å¤šçº¿ç¨‹ä¸‹è½½å·¥å…·ï¼ˆå¦‚ FlashGetã€è¿…é›·ç­‰ï¼‰å®ç°å¤šçº¿ç¨‹ä¸‹è½½çš„æ ¸å¿ƒæ‰€åœ¨ã€‚
![](https://img2018.cnblogs.com/blog/736399/201902/736399-20190228213152235-149514724.jpg)
å¦‚ä½•åœ¨ä»£ç ä¸­å®ç°ç”¨å‘¢ï¼Œæ¥æ¥ç€å¾€ä¸‹çœ‹
### HTTPè¯·æ±‚å¤´Range
rangeæ˜¯è¯·æ±‚èµ„æºçš„éƒ¨åˆ†å†…å®¹ï¼ˆä¸åŒ…æ‹¬å“åº”å¤´çš„å¤§å°ï¼‰ï¼Œå•ä½æ˜¯byteï¼Œå³å­—èŠ‚ï¼Œä»0å¼€å§‹.
å¦‚æœæœåŠ¡å™¨èƒ½å¤Ÿæ­£å¸¸å“åº”çš„è¯ï¼ŒæœåŠ¡å™¨ä¼šè¿”å› 206 Partial Content çš„çŠ¶æ€ç åŠè¯´æ˜.
å¦‚æœä¸èƒ½å¤„ç†è¿™ç§Rangeçš„è¯ï¼Œå°±ä¼šè¿”å›æ•´ä¸ªèµ„æºä»¥åŠå“åº”çŠ¶æ€ç ä¸º 200 OK .ï¼ˆè¿™ä¸ªè¦æ³¨æ„ï¼Œè¦åˆ†æ®µä¸‹è½½æ—¶ï¼Œè¦å…ˆåˆ¤æ–­è¿™ä¸ªï¼‰
#### Rangeè¯·æ±‚å¤´æ ¼å¼
```
Range: bytes=start-end
```
#### Rangeå¤´åŸŸ  
Rangeå¤´åŸŸå¯ä»¥è¯·æ±‚å®ä½“çš„ä¸€ä¸ªæˆ–è€…å¤šä¸ªå­èŒƒå›´ã€‚ä¾‹å¦‚ï¼Œ  
è¡¨ç¤ºå¤´500ä¸ªå­—èŠ‚ï¼šbytes=0-499  
è¡¨ç¤ºç¬¬äºŒä¸ª500å­—èŠ‚ï¼šbytes=500-999  
è¡¨ç¤ºæœ€å500ä¸ªå­—èŠ‚ï¼šbytes=-500  
è¡¨ç¤º500å­—èŠ‚ä»¥åçš„èŒƒå›´ï¼šbytes=500-  
ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªå­—èŠ‚ï¼šbytes=0-0,-1  
åŒæ—¶æŒ‡å®šå‡ ä¸ªèŒƒå›´ï¼šbytes=500-600,601-999 
ä¾‹å¦‚
```
Range: bytes=10- ï¼šç¬¬10ä¸ªå­—èŠ‚åŠæœ€åä¸ªå­—èŠ‚çš„æ•°æ®
Range: bytes=40-100 ï¼šç¬¬40ä¸ªå­—èŠ‚åˆ°ç¬¬100ä¸ªå­—èŠ‚ä¹‹é—´çš„æ•°æ®.
```
æ³¨æ„ï¼Œè¿™ä¸ªè¡¨ç¤º[start,end]ï¼Œå³æ˜¯åŒ…å«è¯·æ±‚å¤´çš„startåŠendå­—èŠ‚çš„ï¼Œæ‰€ä»¥ï¼Œä¸‹ä¸€ä¸ªè¯·æ±‚ï¼Œåº”è¯¥æ˜¯ä¸Šä¸€ä¸ªè¯·æ±‚çš„[end+1, nextEnd]
###ä¸‹è½½å®ä¾‹
ä¸‹é¢æˆ‘ä»¬é€šè¿‡å…·ä½“çš„ä»£ç å»è¿›ä¸€æ­¥äº†è§£ä¸€äº›ç»†èŠ‚ã€‚
```
import requests
import tqdm
 def download_from_url(url, dst):
    response = requests.get(url, stream=True) #(1)
    file_size = int(response.headers['content-length']) #(2)
    if os.path.exists(dst):
        first_byte = os.path.getsize(dst) #(3)
    else:
        first_byte = 0
    if first_byte >= file_size: #(4)
        return file_size
    header = {"Range": f"bytes={first_byte}-{file_size}"} 
    pbar = tqdm(
        total=file_size, initial=first_byte,
        unit='B', unit_scale=True, desc=dst)
    req = requests.get(url, headers=header, stream=True) #(5)
    with(open(dst, 'ab')) as f:
        for chunk in req.iter_content(chunk_size=1024): #(6)
            if chunk:
                f.write(chunk)
                pbar.update(1024)
    pbar.close()
    return file_size
```
ä¸‹é¢æˆ‘ä»¬å¼€å§‹è§£è¯»æ ‡æœ‰æ³¨é‡Šçš„ä»£ç :
tqdmæ˜¯ä¸€ä¸ªå¯ä»¥æ˜¾ç¤ºè¿›åº¦æ¡çš„åŒ…ï¼Œå…·ä½“çš„ç”¨æ³•å¯ä»¥å‚è€ƒå®˜ç½‘æ–‡æ¡£:https://pypi.org/project/tqdm/
(1)è®¾ç½®stream=Trueå‚æ•°è¯»å–å¤§æ–‡ä»¶ã€‚
(2)é€šè¿‡headerçš„content-lengthå±æ€§å¯ä»¥è·å–æ–‡ä»¶çš„æ€»å®¹é‡ã€‚
(3)è·å–æœ¬åœ°å·²ç»ä¸‹è½½çš„éƒ¨åˆ†æ–‡ä»¶çš„å®¹é‡ï¼Œæ–¹ä¾¿ç»§ç»­ä¸‹è½½ï¼Œå½“ç„¶éœ€è¦åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å°±ä»å¤´å¼€å§‹ä¸‹è½½ã€‚
(4)æœ¬åœ°å·²ä¸‹è½½æ–‡ä»¶çš„æ€»å®¹é‡å’Œç½‘ç»œæ–‡ä»¶çš„å®é™…å®¹é‡è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœå¤§äºæˆ–è€…ç­‰äºåˆ™è¡¨ç¤ºå·²ç»ä¸‹è½½å®Œæˆï¼Œå¦åˆ™ç»§ç»­ã€‚
(5)å¼€å§‹è¯·æ±‚è§†é¢‘æ–‡ä»¶äº†
(6)å¾ªç¯è¯»å–æ¯æ¬¡è¯»å–ä¸€ä¸ª1024ä¸ªå­—èŠ‚ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥è®¾ç½®512ä¸ªå­—èŠ‚
###æ•ˆæœæ¼”ç¤º
é¦–å…ˆè°ƒç”¨ä¸Šé¢çš„æ–¹æ³•å¹¶ä¼ å…¥å‚æ•°ã€‚
```
url = "http://v11-tt.ixigua.com/7da2b219bc734de0f0d04706a9629b61/5c77ed4b/video/m/220d4f4e99b7bfd49efb110892d892bea9011612eb3100006b7bebf69d81/?rc=am12NDw4dGlqajMzNzYzM0ApQHRAbzU6Ojw8MzQzMzU4NTUzNDVvQGgzdSlAZjN1KWRzcmd5a3VyZ3lybHh3Zjc2QHFubHBfZDJrbV8tLTYxL3NzLW8jbyMxLTEtLzEtLjMvLTUvNi06I28jOmEtcSM6YHZpXGJmK2BeYmYrXnFsOiMzLl4%3D"
download_from_url(url, "å¤ç›®å‹äººå¸ç¬¬ä¸€é›†.mp4")
```
åœ¨å‘½ä»¤è¡Œä¸­è¿è¡Œä»£ç ä¹‹åçœ‹åˆ°æ•ˆæœå¦‚ä¸‹
![](https://img2018.cnblogs.com/blog/736399/201902/736399-20190228210024472-1332951661.gif)
å¦‚æœåœ¨pycharmç›´æ¥è¿è¡Œçš„è¯æ˜¯ä¸‹é¢çš„æ•ˆæœ
![](https://img2018.cnblogs.com/blog/736399/201902/736399-20190228210315069-60897625.gif)

å®Œå…¨ä¸ä¸€æ ·çš„æ•ˆæœï¼Œä¸ªäººæ„Ÿè§‰è¿˜æ˜¯åœ¨pycharmé‡Œçœ‹ç€èˆ’æœ,åé¢å¹¶å‘çš„æ—¶å€™çœ‹ç€ä¹Ÿæ–¹ä¾¿ã€‚
å¥½äº†ä¸‹é¢æˆ‘ä»¬å°±æ‰“å¼€æˆ‘ä»¬çš„æ–‡ä»¶çœ‹çœ‹ç»“æœå¦‚ä½•:
![](https://img2018.cnblogs.com/blog/736399/201902/736399-20190228210034910-1916435539.gif)
å¯ä»¥å‘ç°è¿™ä¸ªè§†é¢‘è¢«æˆåŠŸçš„ä¸‹è½½ä¸‹æ¥ï¼Œæ€ä¹ˆæ ·æ¿€ä¸åŠ¨æ¿€ä¸åŠ¨å•Šã€‚
![](https://img2018.cnblogs.com/blog/736399/201902/736399-20190228213140324-2028911776.gif)
å¯¹äºå•æ–‡ä»¶çš„ä¸‹è½½æˆ‘ä»¬å°±å®Œæˆ,ä½†æ˜¯å¯¹äºå¤ç›®å‹äººå¸è¿™ä¸ªåŠ¨æ¼«æ¥è¯´ä¸åªæœ‰ä¸€é›†,å¦‚æœæˆ‘ä»¬ä¸‹è½½ä¸€ä¸ªç³»åˆ—çš„è¯,æˆ‘ä»¬å°±å¾—ä½¿ç”¨å¹¶å‘äº†,è¿™é‡Œæˆ‘ä½¿ç”¨aiohttpæŠŠä¸Šé¢çš„ä»£ç æ”¹æˆå¹¶å‘çš„ç‰ˆæœ¬ã€‚
### ä½¿ç”¨aiohttpè¿›è¡Œå¹¶å‘ä¸‹è½½
```
import aiohttp
import asyncio
from tqdm import tqdm
async def fetch(session, url, dst, pbar=None, headers=None):
    if headers:
        async with session.get(url, headers=headers) as req:
            with(open(dst, 'ab')) as f:
                while True:
                    chunk = await req.content.read(1024)
                    if not chunk:
                        break
                    f.write(chunk)
                    pbar.update(1024)
            pbar.close()
    else:
        async with session.get(url) as req:
            return req


async def async_download_from_url(url, dst):
    '''å¼‚æ­¥'''
    async with aiohttp.connector.TCPConnector(limit=300, force_close=True, enable_cleanup_closed=True) as tc:
        async with aiohttp.ClientSession(connector=tc) as session:
            req = await fetch(session, url, dst)

            file_size = int(req.headers['content-length'])
            print(f"è·å–è§†é¢‘æ€»é•¿åº¦:{file_size}")
            if os.path.exists(dst):
                first_byte = os.path.getsize(dst)
            else:
                first_byte = 0
            if first_byte >= file_size:
                return file_size
            header = {"Range": f"bytes={first_byte}-{file_size}"}
            pbar = tqdm(
                total=file_size, initial=first_byte,
                unit='B', unit_scale=True, desc=dst)
            await fetch(session, url, dst, pbar=pbar, headers=header)
```
ä¸Šé¢çš„ä»£ç åŠŸèƒ½å’Œæˆ‘ä»¬çš„åŒæ­¥ä»£ç ä¸€æ ·çš„ï¼Œä¸åŒçš„æ˜¯è¿™é‡Œæ˜¯å¼‚æ­¥çš„ã€‚
![](https://img2018.cnblogs.com/blog/736399/201902/736399-20190228212820538-1650126491.jpg)
### å¹¶å‘ä¸‹è½½æ¼”ç¤º
æˆ‘ä»¬é¦–å…ˆè¦æ‹¿åˆ°MP4çš„é“¾æ¥,ç„¶åè¿›è¡Œä¸‹é¢çš„ä»£ç å³å¯
```
         task = [asyncio.ensure_future(async_download_from_url(url, f"{i}.mp4")) for i in range(1, 12)]
         loop = asyncio.get_event_loop()
         loop.run_until_complete(asyncio.wait(task))
         loop.close()
```
è¿™é‡Œæˆ‘åŒæ—¶ä¸‹è½½äº†11æ¬¡ä¸Šé¢çš„é‚£ä¸ªè§†é¢‘,å‘½ä»¤ä¸º1-11,æ–¹ä¾¿æ¼”ç¤ºæ•ˆæœ,å¥½äº†ä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹æ•ˆæœã€‚
![](https://img2018.cnblogs.com/blog/736399/201902/736399-20190228212001382-1666462070.gif)
å¯ä»¥å‘ç°å¼€å§‹å¹¶å‘çš„ä¸‹è½½äº†ã€‚
åˆ°è¿™é‡Œæˆ‘ä»¬çš„æ•™ç¨‹å°±ç»“æŸäº†ï¼Œæ€ä¹ˆæ ·æ˜¯ä¸æ˜¯è¿«ä¸åŠå¾…æƒ³è¯•è¯•å‘¢ã€‚å¦å¤–å†è¯´å¥é¢˜å¤–è¯å¤ç›®å‹äººå¸å‰§åœºç‰ˆ,3æœˆ7æ—¥åœ¨ä¸­å›½ä¸Šæ˜ äº†ï¼Œå–œæ¬¢æ²»æ„ˆç³»åŠ¨æ¼«çš„å°ä¼™ä¼´ä¸è¦é”™è¿‡å“¦ã€‚
![](https://img2018.cnblogs.com/blog/736399/201902/736399-20190228213130321-621748554.jpg)
